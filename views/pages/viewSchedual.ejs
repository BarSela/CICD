<!DOCTYPE html>
<html lang='en'>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset='utf-8' />
  <link href='https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.css' rel='stylesheet'>
  <link href='https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.1/css/all.css' rel='stylesheet'>
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Muli:300,400,600,800,900' />
  <link href='/main.css' rel='stylesheet' />
  <script src='/main.js'></script>
  <script>

    // Loading the calendar
    document.addEventListener('DOMContentLoaded', function () {
      calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        aspectRatio: 1.5,
        height: 800,
        selectable: false,
        headerToolbar: {

          left: 'today',
          center: 'prev,title,next',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'

        },

        eventClick: function (info) {

          
          info.el.addEventListener("click", function () {
            

            if (info.event.title == "unavailable") {
              alert("<%= trainer.fullName %>" +" is not available at this time");
            }
            else{
              let form = document.getElementById("newTrainingForm");
            document.getElementById("type").innerHTML = info.event.title;
            document.getElementById("typeIn").value = info.event.title;

            document.getElementById("date").innerHTML = info.event.start.toString();
            document.getElementById("dateIn").value = info.event.start.toString();

            document.getElementById("duration").innerHTML = info.event.extendedProps.duration;
            document.getElementById("durationIn").value = info.event.extendedProps.duration;

            document.getElementById("start").innerHTML = info.event.extendedProps.startHour;
            document.getElementById("startIn").value = info.event.extendedProps.startHour;

            document.getElementById("price").innerHTML = info.event.extendedProps.price;
            document.getElementById("priceIn").value = info.event.extendedProps.price;

            document.getElementById("cover").style.display = "block";;
            form.style.position = "absolute";
            form.style.left = info.jsEvent.pageX + 'px';
            form.style.top = info.jsEvent.pageY + 'px';
            }

          }
          )
        }


      });
      "<% trainer.trainings.forEach(t => { %>"
      type = "<%= t.trainingType %>"
      dateStr = "<%= t.trainingDate %>"
      time = "<%= t.startHour %>"
      duration = "<%= t.duration %>"
      price = "<%= t.price %>"
      id = "<%= t._id %>"
      available = "<%= t.available %>"
      date = new Date(dateStr + 'T' + time); // will be in local time
      endTime = calculateEndTime(time, parseInt(duration));
      console.log(endTime);
      endDate = new Date(dateStr + 'T' + endTime);
      
      calendar.addEvent({
        id: id,
        title: type,
        start: date,
        end: endDate,
        allDay: false,
        extendedProps: {
          startHour: time,
          duration: duration,
          price: price,
          available:available
        }
      });
      "<% }); %>"
      //UNAVALIABLE
      "<% trainer.unAvailable.forEach(u => { %>"
      uID = "<%= u._id %>"
      uDate = "<%= u.date %>"
      uStart = ""
      uEnd = "";
      allDay = "<%= u.allDay %>"
      date = new Date(uDate); // will be in local time
      if (allDay == "false") {
        uStart = "<%= u.startHour %>"
        uEnd = "<%= u.endHour %>"
        date = new Date(uDate + 'T' + uStart); // will be in local time
        calendar.addEvent({
          id: uID,
          title: "unavailable",
          start: date,
          end: date,
          allDay: false,
          extendedProps: {
            startHour: uStart,
            endHour: uEnd
          },

        });
      }
      else {//allDay = true
        calendar.addEvent({
          id: uID,
          title: "unavailable",
          start: date,
          end: date,
          allDay: true,
          display: 'background'
        });
      }

      "<% }); %>"
      function calculateEndTime(start, duration) {
        let hour = parseInt(start.slice(0, 2));
        let minutes = parseInt(start.slice(3));
        let hourToAdd = 0;
        let minutesToAdd = 0;
        console.log("duration = " +duration);

        if (duration >= 60) {
          hourToAdd = parseInt(duration / 60);
          minutesToAdd = duration % 60;

        }
        else {
          minutesToAdd = duration;
          if (minutesToAdd + minutes >= 60) {
            hourToAdd++;
            minutesToAdd = (minutesToAdd + minutes) - 60;
            minutes = 0;

          }
        }
        if (hour + hourToAdd <= 23) {
          hour += hourToAdd;
        }
        else {
          hour = (hour + hourToAdd) % 24;
        }
        if (minutes + minutesToAdd <= 60) {
          minutes += minutesToAdd;


        }
        else {
          hour++;
          minutes = minutes + minutesToAdd - 60;
        }
        minStr = minutes.toString();
        if(minStr.length  > 2){
          len = minStr.length;
          minStr.slice(0, len);

        }
        return hour.toString() + ":" + minStr;
      }
      calendar.render();

    });
  </script>
</head>

<body>


  <%- include('../partials/navbar') %>

    <%- include('../partials/traineeSidebar') %>
      <main>
        <div class="calendar-container">
          <div id='calendar'></div>
        </div>
        <div id="cover">
          <!-- registration form -->
          <div class="popover fullcalendar-event-popover fade show bs-popover-left" role="tooltip" id="popover17030"
            x-placement="left"
            style="position: absolute;will-change: transform;top: 0px;left: 0px;transform: translate3d(425px, 168px, 0px);">
            <div class="arrow" style="top: 186px;">
            </div>
            <h3 class="popover-header">
            </h3>
            <div class="popover-body">
              <h3 class="mb-4" id="type">Yoga</h3>
              <form class="form-container" action="/TrainingReg" method="POST">
                <ul class="list-group">
                  <input id="trainerEmail" name="trainerEmail" value="<%= trainer.email %>" style="display: none;" />
                  <span><strong class="text-dark">Trainier:"<%= trainer.fullName %>"</strong><span class="text-dark text-capitalize"
                      id="trainerName"></span></span> <input id="typeIn" name="typeIn" style="display: none;" />
                  <span><strong class="text-dark">Date:</strong> <span class="text-dark text-capitalize" id="date">
                      &nbsp; </span></span><input name="dateIn" id="dateIn" style="display: none;" />
                  <span><strong class="text-dark">Start Hour:</strong> <span class="text-dark text-capitalize"
                      id="start"> &nbsp; </span></span><input id="startIn" name="startIn" style="display: none;" />
                  <span><strong class="text-dark">Duration:</strong> <span class="text-dark text-capitalize"
                      id="duration"> </span></span><input id="durationIn" name="durationIn" style="display: none;" />
                  <span><strong class="text-dark">Price:</strong> <span class="text-dark text-capitalize" id="price">
                      &nbsp; </span></span><input id="priceIn" name="priceIn" style="display: none;" />
                </ul>
                <!-- button group  -->
                <div class="d-flex justify-content-end">
                  <a id="closePopover" class="btn btn-sm btn-white mr-2" onclick="closeForm()">Close</a>
                  <button class="btn btn-sm btn-primary" type="submit" id="reg-btn">
                    registration
                  </button>
                </div>
            </div>
          </div>
          </form>
        </div>

      </main>
      <script>
        function openForm() {
          document.getElementById("cover").style.display = "block";

        }

        function closeForm() {
          document.getElementById("cover").style.display = "none";

        }


      </script>
</body>

</html>
